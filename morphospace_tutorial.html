<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pablo Milla Carmona. Adapted by Thomas J. Smith.">

<title>Morphospace tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="morphospace_tutorial_files/libs/clipboard/clipboard.min.js"></script>
<script src="morphospace_tutorial_files/libs/quarto-html/quarto.js"></script>
<script src="morphospace_tutorial_files/libs/quarto-html/popper.min.js"></script>
<script src="morphospace_tutorial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="morphospace_tutorial_files/libs/quarto-html/anchor.min.js"></script>
<link href="morphospace_tutorial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="morphospace_tutorial_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="morphospace_tutorial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="morphospace_tutorial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="morphospace_tutorial_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Morphospace tutorial</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Pablo Milla Carmona. Adapted by Thomas J. Smith. </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1.0 Introduction</h2>
<p>morphospace has been built to work in intergration with other widely used R packages covering other more essential steps in the geometric morphometrics pipeline (e.g.&nbsp;importation, normalization, statistical analysis) such as Morpho (Schlager 2017), geomorph (Adams et al.&nbsp;2021), shapes (Dryden 2019), and Momocs (Bonhome et al.&nbsp;2014).</p>
<section id="load-libraries-and-data" class="level3">
<h3 class="anchored" data-anchor-id="load-libraries-and-data">1.1 Load libraries and data</h3>
<p>First, let’s install morphospace from github. Install the devtools package if you need to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("devtools")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"millacarmona/morphospace"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Skipping install of 'morphospace' from a github remote, the SHA1 (2bc7bee8) has not changed since last install.
  Use `force = TRUE` to force installation</code></pre>
</div>
</div>
<p>Now load the libraries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(morphospace)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geomorph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: RRPP</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rgl</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The basic idea behind morphospace is to build empirical morphospaces using multivariate methods, then use the resulting ordination as a reference frame in which elements representing different aspects of morphometric variation can projected. This workflow is outlined below using the tails data set from Fasanelli et al.&nbsp;(2022), which contains a sample of tail shapes from the 13 species of the genus Tyrannus (kingbirds and flycatchers). Two of these (the flycatchers T. savana and T. forficatus) display exaggeratedly elongated tails, as well as a considerable allometric variation and sexual dimorphism. The tails data set contains landmark data and centroid sizes from the tails of 281 specimens, their classification to species, sex and type (deep-forked, DF or non deep-forked, NDF), and their phylogenetic relationships (see Fasanelli et al.&nbsp;2022 and references therein). The links between landmarks have been also included to improve visualization.</p>
<p>When loading data, make sure you set the correct working directory!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tail data and extract shapes, centroid sizes, classification of sex </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and species, links between landmarks, and phylogenetic tree</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"datasets"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>tails <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"tails.Rds"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>shapes <span class="ot">&lt;-</span> tails<span class="sc">$</span>shapes</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">log</span>(tails<span class="sc">$</span>sizes)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>spp <span class="ot">&lt;-</span> tails<span class="sc">$</span>data<span class="sc">$</span>species</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>sex <span class="ot">&lt;-</span> tails<span class="sc">$</span>data<span class="sc">$</span>sex</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>wf <span class="ot">&lt;-</span> tails<span class="sc">$</span>links</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>phy <span class="ot">&lt;-</span> tails<span class="sc">$</span>tree</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="removing-sexual-dimorphism" class="level3">
<h3 class="anchored" data-anchor-id="removing-sexual-dimorphism">1.2 Removing sexual dimorphism</h3>
<p>The starting point of this workflow is morphometric data that is already free of differences in orientation, position and scale (this standardization can be implemented using functions provided by the aforementioned R packages). However, morphospace provide some alternatives to perform some basic operations on shape data, such as the calculation of mean shapes or the analytical removal of undesired sources of variation (functions expected_shapes and detrend_shapes, respectively). For example, we can to get rid of sexual dimorphism before moving forward.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove variation associated with sexual dimorphism and compute the </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># consensus shape of each species</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">two.d.array</span>(shapes) <span class="sc">~</span> sex)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>detr_shapes <span class="ot">&lt;-</span> <span class="fu">detrend_shapes</span>(model, <span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="fu">nrow</span>(shapes), <span class="at">k =</span> <span class="fu">ncol</span>(shapes))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>sp_shapes <span class="ot">&lt;-</span> <span class="fu">expected_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">x =</span> spp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="generating-morphospaces" class="level2">
<h2 class="anchored" data-anchor-id="generating-morphospaces">2.0 Generating morphospaces</h2>
<p>Once the shape data is ready, we build a morphospace using the mspace function and then use the resulting ordination as a canvas in which to project different elements depicting various aspects of morphometric variation (scatter points, groups centroids, convex hulls, confidence ellipses, a phylogeny, etc). These elements are added both to the plot and the “mspace” object as consecutive ‘layers’ and list slots, respectively, using the proj_* family of functions and the %&gt;% pipe operator from the magrittr package (Bache &amp; Wickham 2022).</p>
<p>For clarity, this is still an empirical morphospace because the data plotted are used to generate the axes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate morphospace using detrended shapes, project specimens</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>msp1 <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now let’s generate our morphospace (i.e.&nbsp;plot the axes), plot the obsevations, and plot convex hulls. All with colour!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>msp2 <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> spp)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace</span><span class="sc">\n</span><span class="st">+ species differentiation"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>How about we add a phylogeny? Let’s use proj_phylogeny to do so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>msp3 <span class="ot">&lt;-</span> <span class="fu">mspace</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> spp) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_phylogeny</span>(<span class="at">shapes =</span> sp_shapes, <span class="at">tree =</span> phy, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace</span><span class="sc">\n</span><span class="st">+ groups + phylogeny"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can check what you’re plotting using the names function. Class is short for classification, scores is shore for…well, scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(msp1<span class="sc">$</span>projected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "shapemodels" "scores"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(msp2<span class="sc">$</span>projected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "shapemodels" "scores"      "gr_class"    "gr_scores"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(msp3<span class="sc">$</span>projected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "shapemodels"  "scores"       "gr_class"     "gr_scores"    "phylo_scores"
[6] "phylo"       </code></pre>
</div>
</div>
<p>Another potentially interesting element that can be projected into morphospaces are morphometric axes or phenotypic change vectors, i.e.&nbsp;synthetic axes built as linear combinations of shape variables that describe a linear path across the morphospace. For example, we can project the first two PC axes resulting from a PCA of the non-deep-forked specimens data into our morphospace. The proj_axis function does this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(<span class="fu">two.d.array</span>(detr_shapes[,,tails<span class="sc">$</span>data<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"NDF"</span>]))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mspace</span>(detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_phylogeny</span>(<span class="at">shapes =</span> sp_shapes, <span class="at">tree =</span> phy, <span class="at">pch.tips =</span> <span class="dv">16</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_axis</span>(<span class="at">obj =</span> pca, <span class="at">axis =</span> <span class="dv">1</span>, <span class="at">mag =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_axis</span>(<span class="at">obj =</span> pca, <span class="at">axis =</span> <span class="dv">2</span>, <span class="at">mag =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace</span><span class="sc">\n</span><span class="st">+ PC1 and PC2 of NDF species projected"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally, landscape surfaces intended to represent functional or performance measurements can be projected as contour maps with proj_landscape. These surfaces are interpolated using the akima package (Akima &amp; Gebhardt 2022) from values provided directly through the argument X and corresponding to the shapes provided through the shapes argument, or computed through the latter using an arbitrary function, provided using the argument FUN.</p>
<p>These landscapes can be computed for either a region of the morphospace from a sample of empirical shapes occupying that region (“empirical landscapes”) or from the set of synthetic shapes mapping morphometric variation in the background (“theoretical landscapes”). For the latter case, leave shapes = NULL; if values are been provided using X these must have been computed beforehand and arranged in the same order as the shape models in the background (that is, from left to right and from bottom to top), which can be extracted using extract_shapes. This last step is not necessary if FUN is provided. A scalebar can be added using plot_mspace and scalebar = TRUE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute lift/drag ratio for each tail in the data set</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Momocs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Momocs'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked _by_ '.GlobalEnv':

    shapes</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:geomorph':

    mosquito</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:morphospace':

    wings</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    filter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>LDs <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">two.d.array</span>(detr_shapes), <span class="dv">1</span>, morphospace<span class="sc">:::</span>computeLD)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># use LDs values to project an empirical landscape</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mspace</span>(detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes) <span class="sc">%&gt;%</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_landscape</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">X =</span> LDs, <span class="at">linear =</span> <span class="cn">TRUE</span>, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">display =</span> <span class="st">"filled.contour"</span>, <span class="at">resolution =</span> <span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now let’s project a theoretical landscape by using the argument “FUN” to run the computeLD function through the background shape models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mspl <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes) <span class="sc">%&gt;%</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_landscape</span>(<span class="at">shapes =</span> <span class="cn">NULL</span>, <span class="at">FUN =</span> morphospace<span class="sc">:::</span> computeLD, <span class="at">linear =</span> <span class="cn">FALSE</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">display =</span> <span class="st">"contour"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A scale bar can be added as such:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(mspl, <span class="at">display.landsc =</span> <span class="st">"filled.contour"</span>, <span class="at">palette.landsc =</span> terrain.colors, <span class="at">scalebar =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="ordination-methods" class="level2">
<h2 class="anchored" data-anchor-id="ordination-methods">3.0 Ordination methods</h2>
<p>The default settings of mspace rely on the prcomp function from the stats package to build the synthetic morphometric space. However, morphospace also provides functions for other ordination methods, namely: 1. Phylogenetic PCA (Revell 2009) (implemented through the phy_prcomp function, which wraps phyl.pca from phytools, Revell 2012). 2. Between-groups PCA, which finds the combinations of traits that maximise the separation of clusters (bg_prcomp function - produces number of axes equal to lowest number of groups minus one, number of original variables, and the number of observations). 3. Both ordinary and phylgenetic versions of Partial Least Squares (PLS), used to test for covariation (pls_shapes function [an user-friendly wrapper of pls2b, which is used in the following chunk to test for covariation with a synthetic covariate]).</p>
<p>These have been styled/wrapped to share format with prcomp, and both bgPCA and PLS functions allow for leave-one-out cross-validation (LOOCV), which alleviates some spurious patterns that arise when the number of variables exceeds the number of samples (as it is common in geometric morphometric analyses; see Cardini et al.&nbsp;2019 and Cardini &amp; Polly 2020).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate 100 random normal distributions, and add an artificial classification </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and an artificial covariate</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>random_y <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"cbind"</span>, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="cf">function</span>(i) {<span class="fu">rnorm</span>(<span class="dv">90</span>)}))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>class <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="at">each =</span> <span class="dv">30</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>random_x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">90</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform bgPCA on the set of random variables to look for the bgPCs maximizing separation between artificial groups, with and without LOOCV</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>bgpca1 <span class="ot">&lt;-</span> <span class="fu">bg_prcomp</span>(<span class="at">x =</span> random_y, <span class="at">groups =</span> class)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bgpca1<span class="sc">$</span>x, <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)[class])</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="fu">hulls_by_group_2D</span>(bgpca1<span class="sc">$</span>x, class)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"bgPCA</span><span class="sc">\n</span><span class="st"> without LOOCV"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>bgpca2 <span class="ot">&lt;-</span> <span class="fu">bg_prcomp</span>(<span class="at">x =</span> random_y, <span class="at">groups =</span> class, <span class="at">LOOCV =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bgpca2<span class="sc">$</span>x, <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)[class])</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">hulls_by_group_2D</span>(bgpca2<span class="sc">$</span>x, class)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"bgPCA</span><span class="sc">\n</span><span class="st"> with LOOCV"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now let’s use PLS to look for the axis maximising covariation between the traits and the artificial covariate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Without LOOCV</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>pls1 <span class="ot">&lt;-</span> <span class="fu">pls2b</span>(<span class="at">x =</span> random_x, <span class="at">y =</span> random_y)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pls1<span class="sc">$</span>xscores, pls1<span class="sc">$</span>yscores)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(pls1<span class="sc">$</span>yscores <span class="sc">~</span> pls1<span class="sc">$</span>xscores), <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"PLS</span><span class="sc">\n</span><span class="st"> without LOOCV"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># With LOOCV</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>pls2 <span class="ot">&lt;-</span> <span class="fu">pls2b</span>(<span class="at">x =</span> random_x, <span class="at">y =</span> random_y, <span class="at">LOOCV =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pls2<span class="sc">$</span>xscores, pls2<span class="sc">$</span>yscores)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(pls2<span class="sc">$</span>yscores <span class="sc">~</span> pls2<span class="sc">$</span>xscores), <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"PLS</span><span class="sc">\n</span><span class="st"> with LOOCV"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These methods can be used instead of regular PCA for building morphospaces via the FUN and … arguments (adding the argument groups for bg_prcomp, tree for phy_prcomp, and X [and potentially also a tree] for pls_shapes, respectively) of the mspace function. The resulting morphospace can be combined with the proj_* functions in the same way as before. Note we can add a legend separately by using plot_mspace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>msp.IV <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">FUN =</span> bg_prcomp, <span class="at">LOOCV =</span> <span class="cn">TRUE</span>, <span class="at">groups =</span> spp, <span class="at">links =</span> wf, <span class="at">invax =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">cex.ldm =</span> <span class="dv">5</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> sp_shapes, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">pch =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(msp.IV, <span class="at">legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace emphasizing interspecific variation"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now for a phylogenetic morphospace version. Phylogenetic PCA for all species, adding projection of intrapspecific variation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>MSP.phyPCA <span class="ot">&lt;-</span> <span class="fu">mspace</span>(sp_shapes, <span class="at">FUN =</span> phy_prcomp, <span class="at">tree =</span> phy, <span class="at">links =</span> wf, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.25</span>, <span class="fl">0.15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.15</span>), <span class="at">cex.ldm =</span> <span class="dv">5</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> sp_shapes, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">pch =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(MSP.phyPCA, <span class="at">legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Phylogenetic morphospace + samples"</span>, <span class="at">cex.main =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="flexible-visualisation" class="level2">
<h2 class="anchored" data-anchor-id="flexible-visualisation">4.0 Flexible visualisation</h2>
<p>Finally, “mspace” objects created using the mspace %&gt;% proj_* pipeline can be regenerated/modified with the plot_mspace function, which adds further graphical flexibility. By plotting a “mspace” object using this function we can regenerate an existing morphospace as it was created; alternatively, we can select a different set of axes to plot, choose other colors and symbols for points, groups, etc (or not), or add a legend (see chunk above). In addition, this function also allow combining morphometric axes with other non-shape variables to produce ‘hybrid’ morphospaces.</p>
<p>For example, PC1 can be plotted against size to explore allometric patterns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build morphospace first</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>msp <span class="ot">&lt;-</span> <span class="fu">mspace</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">links =</span> wf, <span class="at">cex.ldm =</span> <span class="dv">5</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> spp) <span class="sc">%&gt;%</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_phylogeny</span>(<span class="at">shapes =</span> sp_shapes, <span class="at">tree =</span> phy, <span class="at">col.tips =</span> <span class="fu">match</span>(phy<span class="sc">$</span>tip.label, <span class="fu">levels</span>(spp)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot PC1 against log-size, add legend</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(msp, <span class="at">x =</span> sizes, <span class="at">axes =</span> <span class="dv">1</span>, <span class="at">nh =</span> <span class="dv">6</span>, <span class="at">nv =</span> <span class="dv">6</span>, <span class="at">cex.ldm =</span> <span class="dv">4</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">col.points =</span> spp, <span class="at">col.groups =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(spp), <span class="at">xlab =</span> <span class="st">"Log-size"</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>How about we plot a phenogram (variation versus time with phylogeny)?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot vertical phenogram using PC1, add a legend</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(msp, <span class="at">y =</span> phy, <span class="at">axes =</span> <span class="dv">1</span>, <span class="at">nh =</span> <span class="dv">6</span>, <span class="at">nv =</span> <span class="dv">6</span>, <span class="at">cex.ldm =</span> <span class="dv">4</span>, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">col.groups =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(spp), <span class="at">ylab =</span> <span class="st">"Time"</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>(Note: that legend’ labels are taken from the factor provided in the groups argument from proj_groups, whereas symbols and colors are taken from proj_shapes and proj_groups graphical parameters)</p>
</section>
<section id="other-examples" class="level2">
<h2 class="anchored" data-anchor-id="other-examples">5.0 Other examples</h2>
<section id="d-landmark-data" class="level3">
<h3 class="anchored" data-anchor-id="d-landmark-data">5.1 2D landmark data</h3>
<p>Most of the capabilities for 2D landmark data visualization is covered in sections 1-4.. This section will quickly show how to use a curve or set of curves outlining aspects of the phenotype not captured by the chosen landmarks to improve visualizations via thin-plate spline (TPS) interpolation. To do so we use the wings data set, which has been taken from Soto et al.&nbsp;(2012) and includes wing shape data from 263 experimentally bred specimens belonging to two recently diverged cactophilic Drosophila species, D. koepferae and D. buzzattii. These two species show preference to different host cacti (columnar cacti from the genus Trichocereus and prickly pears from the genus Opuntia, respectively) and are considered morphologically cryptic (usually, they can be recognized only from genital morphology). The data set include the centroid size of each wing, as well as information on the host cacti each specimen was bred on, its species, sex, isofemale line, and replica. Also included is a template containing a series of curves describing wing outline and veins (created using build_template2d), which will be warped using TPS interpolation and used to generate fancy shape models for our morphospace.</p>
<p>First, let’s load the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load wing data </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"datasets"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>wings <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"wings.Rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extract shapes, centroid sizes, classification of sex and species, links between landmarks, template, and phylogeny</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>shapes <span class="ot">&lt;-</span> wings<span class="sc">$</span>shapes</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">as.numeric</span>(wings<span class="sc">$</span>sizes))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sizes) <span class="ot">&lt;-</span> <span class="fu">names</span>(wings<span class="sc">$</span>sizes)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> wings<span class="sc">$</span>data<span class="sc">$</span>species</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>cactus <span class="ot">&lt;-</span> wings<span class="sc">$</span>data<span class="sc">$</span>cactus</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>line <span class="ot">&lt;-</span> wings<span class="sc">$</span>data<span class="sc">$</span>line</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>sex <span class="ot">&lt;-</span> wings<span class="sc">$</span>data<span class="sc">$</span>sex</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>replica <span class="ot">&lt;-</span> wings<span class="sc">$</span>data<span class="sc">$</span>replica</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>curvs <span class="ot">&lt;-</span> wings<span class="sc">$</span>template</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="fu">pile_shapes</span>(shapes, <span class="at">links =</span> wings<span class="sc">$</span>links)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now let’s generate a morphospace with warped wings as background models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate morphospace but use warped wings as background models</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>spxcac <span class="ot">&lt;-</span> species<span class="sc">:</span>cactus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mspace</span>(shapes, <span class="at">template =</span> curvs, <span class="at">col.ldm =</span> <span class="st">"black"</span>, <span class="at">cex.ldm =</span> <span class="dv">5</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> shapes, </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">each =</span> <span class="dv">2</span>)[spxcac], </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">16</span>, <span class="dv">1</span>), <span class="at">times =</span> <span class="dv">2</span>)[spxcac]) <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> shapes, <span class="at">groups =</span> spxcac, <span class="at">ellipse =</span> <span class="cn">TRUE</span>, </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">each =</span> <span class="dv">2</span>), </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">lty =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">times =</span> <span class="dv">2</span>), <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_mspace</span>(<span class="at">legend =</span> <span class="cn">TRUE</span>, <span class="at">cex.legend =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace using template"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s assume for a second we are interested in exploring whether we can identify morphological differences between species. The pattern we are seeing suggests that variation in wing morphology is very subtle, that wings of these two species are basically indistinguishable, and that cactus has a large effect on wing morphology. However, there is a lot of ‘noise’ (i.e.&nbsp;sexual dimorphism, allometric variation, genetic variation, even host cactus) we can get rid of using detrend_shapes. We do this species-wise, so that patterns of interspecific variation are not blurred.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>detr_shapes <span class="ot">&lt;-</span> shapes <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> species <span class="sc">==</span> <span class="fu">levels</span>(species)[i]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  subshapes <span class="ot">&lt;-</span> shapes[,,index]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  subsex <span class="ot">&lt;-</span> sex[index]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  subline <span class="ot">&lt;-</span> line[index]</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  subreplica <span class="ot">&lt;-</span> replica[index]</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  subsizes <span class="ot">&lt;-</span> sizes[index]</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  subcactus <span class="ot">&lt;-</span> cactus[index]</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  subdetr_shapes1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">two.d.array</span>(subshapes) <span class="sc">~</span> subsex <span class="sc">*</span> subline <span class="sc">*</span> subreplica) <span class="sc">%&gt;%</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">detrend_shapes</span>(<span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="dv">9</span>, <span class="at">k =</span> <span class="dv">2</span>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  subdetr_shapes2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">two.d.array</span>(subdetr_shapes1) <span class="sc">~</span> subsizes) <span class="sc">%&gt;%</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">detrend_shapes</span>(<span class="at">xvalue =</span> <span class="fu">max</span>(subsizes), <span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="dv">9</span>, <span class="at">k =</span> <span class="dv">2</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  subdetr_shapes3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">two.d.array</span>(subdetr_shapes2) <span class="sc">~</span> subcactus) <span class="sc">%&gt;%</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">detrend_shapes</span>(<span class="at">xvalue =</span> <span class="fu">c</span>(<span class="st">"Op"</span>, <span class="st">"Tr"</span>)[i], <span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="dv">9</span>, <span class="at">k =</span> <span class="dv">2</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  detr_shapes[,,index] <span class="ot">&lt;-</span> subdetr_shapes3</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(Note: we do this in several step for a good reason: when we use detrend_shapes to detrend shape variation, the grand mean is used by default as the new mean shape of the sample; however by specifying a value or level of x from the model in the xvalue argument, we can use that new value as the mean shape for our ‘detrended’ shape variation. In this case, we are analitically displacing all the wings to the shapes they should have if reared in their primary host cactus, and attained their species’ maximum size).</p>
<p>Once shape variation has been ‘refined’, we can ordinate it again, and magnify variation so the representation can be more easily interpreted using the mag argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mspace</span>(detr_shapes, <span class="at">template =</span> curvs, <span class="at">col.ldm =</span> <span class="st">"black"</span>,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">cex.ldm =</span> <span class="dv">5</span>, <span class="at">mag =</span> <span class="dv">2</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">each =</span> <span class="dv">2</span>)[spxcac], </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">16</span>, <span class="dv">1</span>), <span class="at">times =</span> <span class="dv">2</span>)[spxcac]) <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">groups =</span> spxcac, <span class="at">ellipse =</span> <span class="cn">TRUE</span>, </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">each =</span> <span class="dv">2</span>), </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">lty =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">times =</span> <span class="dv">2</span>), <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_mspace</span>(<span class="at">legend =</span> <span class="cn">TRUE</span>, <span class="at">cex.legend =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So, after ‘cleaning’ the raw variation interspecific differences become apparent with each species occupying different regions of wing morphospace (elongated and more triangular in D. koepferae, relatively higher and more rounded in D. buzzattii).</p>
</section>
<section id="closed-outlines" class="level3">
<h3 class="anchored" data-anchor-id="closed-outlines">5.2 Closed outlines</h3>
<p>morphospace can also handle closed outline data in the form of Fourier coefficients resulting from an elliptic Fourier analysis. For the purposes of import, normalize and and analize this data we rely on the Momocs package, and use its “OutCoe” format for storing closed outlines as starting point. Below the mspace %&gt;% proj_* workflow is applied to the shells data set taken from Milla Carmona et al.&nbsp;(2018). This include data from 137 specimens belonging to 4 species of the extinct bivalve genus Ptychomya, tracking their shape changes through a 5 million years interval from the Lower Cretaceous of Argentina. The data set includes the information about the shape (measured using 7 harmonics), centroid size, geochronologic age (both relative and absolute), geographic provenance, and taxonomic classification of each specimen.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Load Momocs</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Momocs)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data from shells, extract shapes and sizes, and gets classifications of species, absolute age, and relative age (bzone)</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"datasets"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>shells <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"shells.Rds"</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>shapes <span class="ot">&lt;-</span> shells<span class="sc">$</span>shapes<span class="sc">$</span>coe</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">log</span>(shells<span class="sc">$</span>sizes)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> shells<span class="sc">$</span>data<span class="sc">$</span>species</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">&lt;-</span> shells<span class="sc">$</span>data<span class="sc">$</span>age</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>bzones <span class="ot">&lt;-</span> shells<span class="sc">$</span>data<span class="sc">$</span>zone</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Pile shapes</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="fu">pile_shapes</span>(shapes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s generate a morphospace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mspace</span>(shapes, <span class="at">bg.model =</span> <span class="st">"light gray"</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> shapes, <span class="at">col =</span> species) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> shapes, <span class="at">groups =</span> species, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> <span class="fu">expected_shapes</span>(shapes, species), <span class="at">bg =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">pch =</span> <span class="dv">21</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_mspace</span>(<span class="at">legend =</span> <span class="cn">TRUE</span>, <span class="at">cex.legend =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-26-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In this case, we are interested in the variation shown by each species throughout the studied interval. As before, we can use detrend_shapes to remove variation associated to nuisance factors (in this case, allometric variation). We do this for species separately, and then use expected_shapes to extract their mean shapes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 'Clean' shapes separately for each species, removing 1) variation associated to geographic provenance and 2) allometric variation</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>detr_shapes <span class="ot">&lt;-</span> shapes <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(species)) {</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> species <span class="sc">==</span> <span class="fu">levels</span>(species)[i]</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  subdetr_shapes <span class="ot">&lt;-</span> <span class="fu">lm</span>(shapes[index,] <span class="sc">~</span> sizes[index]) <span class="sc">%&gt;%</span> <span class="fu">detrend_shapes</span>(<span class="at">xvalue =</span> <span class="fu">max</span>(sizes[index]), <span class="at">method =</span> <span class="st">"residuals"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  detr_shapes[<span class="fu">rownames</span>(detr_shapes) <span class="sc">%in%</span> <span class="fu">rownames</span>(subdetr_shapes),] <span class="ot">&lt;-</span> subdetr_shapes</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we don’t need arrayspecs when using detrend_shapes here, that’s because Fourier coefficients are already stored in matrix format).</p>
<p>Now we can use plot_mspace again to create a more complex hybrid plot combining shape changes associated to PC1 against the time axis. To do so, we first do a bit of variable manipulation to obtain 1) a factor combining species classification and relative age (i.e.&nbsp;biozones), and 2) the mean shapes and 3) mean ages of the resulting levels. Then, we build the morphospace (this time, using detrended shapes and between-groups PCA).</p>
<p>(Note: in this case, two separate instances of proj_shapes are used: one for projecting the sampled shapes, and another one to project the mean shape of each species in each biozone. The corresponding scores are stored together in the order in which shapes were projected; see next chunk for an example of how to call them.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine levels of species and biozones, then compute 1) the mean shapes and 2) the mean ages of the resulting groups</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>sp.bz <span class="ot">&lt;-</span> <span class="fu">factor</span>(species<span class="sc">:</span>bzones)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>shapes_agesxspecies <span class="ot">&lt;-</span> <span class="fu">expected_shapes</span>(detr_shapes, sp.bz)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>mean_ages <span class="ot">&lt;-</span> <span class="fu">tapply</span>(ages, sp.bz, mean)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate morphospace (use an additional instance of proj_shapes to project the mean shapes of species:biozones)</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>msp <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">FUN =</span> bg_prcomp, <span class="at">groups =</span> species,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">mag =</span> <span class="fl">0.5</span>, <span class="at">bg.model =</span> <span class="st">"light gray"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> shapes_agesxspecies, <span class="at">pch =</span> <span class="dv">21</span>, </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">bg =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="fu">rep</span>(<span class="dv">2</span>,<span class="dv">6</span>), <span class="fu">rep</span>(<span class="dv">3</span>,<span class="dv">9</span>), <span class="fu">rep</span>(<span class="dv">4</span>,<span class="dv">3</span>)), <span class="at">cex =</span> <span class="fl">1.2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">col =</span> species) <span class="sc">%&gt;%</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">groups =</span> species, <span class="at">alpha =</span> <span class="fl">0.2</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add intraspecific variation through time trajectories in morphospace</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="at">x =</span> <span class="fu">rownames</span>(msp<span class="sc">$</span>projected<span class="sc">$</span>scores), <span class="at">pattern =</span> <span class="fu">levels</span>(species)[i])</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(msp<span class="sc">$</span>projected<span class="sc">$</span>scores[index,], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> i)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally, we use plot_mspace to plot geochronologic age against shape. To add lines connecting the mean shape of each combination of species and biozone, we first bind them as columns, order them, and use a for loop . This particular ‘hybrid’ morphospace is much more useful to depict species’ mean morphological changes through time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Another visualization (probably better to interpreting temporal patterns): </span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot time axis vs first bgPC</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(msp, <span class="at">x =</span> <span class="fu">c</span>(mean_ages, ages), <span class="at">groups =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in morphogrid(ordination = ordination, axes = args$axes, datype =
mspace$ordination$datype, : x or y has been specified, axes[2] will be ignored</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine 1) scores corresponding to mean shapes and 2) mean ages for each </span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># level of species:biozone </span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>xy <span class="ot">&lt;-</span> <span class="fu">cbind</span>(mean_ages, msp<span class="sc">$</span>projected<span class="sc">$</span>scores[<span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(sp.bz), <span class="dv">1</span>])</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>xy <span class="ot">&lt;-</span> xy[<span class="fu">order</span>(xy[,<span class="dv">1</span>]),]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Add intraspecific variation through time  trajectories in 'stratomorphospace'</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(species)) {</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="at">x =</span> <span class="fu">rownames</span>(xy), <span class="at">pattern =</span> <span class="fu">levels</span>(species)[i])</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(xy[index,], <span class="at">col =</span> i, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">' "Stratomorphospace" '</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From these plots we can say that, regarding the shell outline, 1) P esbelta is rather different from the rest of the species, 2) P coihuicoensis and P. windhauseni are very similar to each other, and 3) most of the species show little or no net change over their stratigraphic span (in other words they seem to be under morphological stasis), with the exception of P. windhauseni which shows a short but noticeable directional trend towards higher shells.</p>
</section>
<section id="d-landmark-data-1" class="level3">
<h3 class="anchored" data-anchor-id="d-landmark-data-1">5.3 3D landmark data</h3>
<p>Last but not least, morphospace can also deal with 3D landmark data (my personal preference for importing and normalizing 3D landmark data are the functions from Morpho, but other packages can do this too). To show how to apply the mspace %&gt;% proj_* workflow we use the shells3D data set taken from Milla Carmona et al.&nbsp;(2021), which gathers longitudinal ontogenetic data from 67 specimens belonging to 7 species of the extinct bivalve genus Steinmanella from the Lower Cretaceous of Argentina. The shape of these specimens was registered at different sizes using growth lines, and so the data set includes a total of 278 shapes quantified using 90 surface semilandmarks. Also included are the corresponding centroid sizes, the id of the specimen each shape was taken from, and information about biostratigraphic age, taxonomic classification and geographic provenance of each specimen. The surface mesh corresponding to the specimen closest to the consensus of the sample (found using geomorph::findMeanSpec) is also included.</p>
<p>The rgl package (Murduch &amp; Adler 2021) is responsible for depiction of 3D models, which imposes some important differences in the way morphospace functions work. Most importantly, each time mspace or plot_mspace is called, a rgl device will pop up and the user will be asked to rotate a reference shape to a desired orientation. Do not close or minimize this window, just expand it and/or rotate and zoom in/out the model and then go to the console and hit Enter there directly.</p>
<p>We start by loading the relevant packages and set a rotation matrix for rgl models (you wouldn’t normally need this step, but because I since cannot rotate the device when knitting this becomes necessary. However it can also be useful to use it in your workflow too, so you don’t need to worry about finding exactly the same orientation over and over again.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Morpho)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Morpho'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:Momocs':

    export, tps2d</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:RRPP':

    classify</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgl)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a rotation matrix</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par3d</span>(<span class="at">userMatrix =</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.92221391</span>,<span class="sc">-</span><span class="fl">0.37156740</span>,<span class="sc">-</span><span class="fl">0.10704762</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="fl">0.37703809</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fl">0.92551011</span>,<span class="fl">0.03568961</span>,<span class="dv">0</span>,<span class="fl">0.08581252</span>,<span class="fl">0.07327446</span>,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">-</span><span class="fl">0.99361324</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we load out data and extract the necessary elements. Keep an eye on your RGL window as you do this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data from 3D shells, extract shapes and classification into species</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"datasets"</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>shells3D <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"shells3D.Rds"</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>shapes <span class="ot">&lt;-</span> shells3D<span class="sc">$</span>shapes</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">log</span>(shells3D<span class="sc">$</span>sizes)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> shells3D<span class="sc">$</span>data<span class="sc">$</span>species</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> shells3D<span class="sc">$</span>data<span class="sc">$</span>individual</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>bzones <span class="ot">&lt;-</span> shells3D<span class="sc">$</span>data<span class="sc">$</span>biozone</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>locality <span class="ot">&lt;-</span> shells3D<span class="sc">$</span>data<span class="sc">$</span>locality</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>mesh_meanspec <span class="ot">&lt;-</span> shells3D<span class="sc">$</span>mesh_meanspec</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="co"># compute consensus of each species</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>sp_shapes <span class="ot">&lt;-</span> <span class="fu">expected_shapes</span>(shapes, species)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Pile shapes</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="fu">pile_shapes</span>(shapes, <span class="at">alpha =</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now to create a morphospace presenting the raw variation in the data. This is interactive, you need to rotate the 3D model by yourself and then press enter into the console.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mspace</span>(shapes, <span class="at">cex.ldm =</span> <span class="dv">2</span>, <span class="at">adj_frame =</span> <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">0.85</span>), <span class="at">plot =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> shapes, <span class="at">bg =</span> species, <span class="at">pch =</span> <span class="dv">21</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">shapes =</span> shapes, <span class="at">groups =</span> species, <span class="at">ellipse =</span> <span class="cn">TRUE</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(sp_shapes, <span class="at">pch =</span> <span class="dv">21</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing for snapshot: rotate mean shape to the desired orientation
 (don't close or minimize the rgl device).Press &lt;Enter&gt; in the console to continue:
This can take a few seconds...
DONE.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Morphospace"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can now focus on ontogenetic shape variation, which was the purpose this data set was built for. Again we resort to detrend shapes to remove variation introduced by undesired sources (which in this case are biostratigraphic level, geographic provenance and, especially, individual differences).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove nuisance variation from the sample for each species (a couple were registered in a single biozone and/or locality, which requires a little adjustment)</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>detr_shapes <span class="ot">&lt;-</span> shapes <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(species)) {</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> species <span class="sc">==</span> <span class="fu">levels</span>(species)[i]</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  subshapes_mat <span class="ot">&lt;-</span> <span class="fu">two.d.array</span>(shapes[,,index])</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  subind <span class="ot">&lt;-</span> ind[index]</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  subloc <span class="ot">&lt;-</span> locality[index]</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  subzone <span class="ot">&lt;-</span> bzones[index]</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">any</span>(i <span class="sc">==</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))) {</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    detr_shapes[,,index] <span class="ot">&lt;-</span> <span class="fu">lm</span>(subshapes_mat <span class="sc">~</span> subind <span class="sc">*</span> subzone <span class="sc">*</span> subloc) <span class="sc">%&gt;%</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">detrend_shapes</span>(<span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="dv">90</span>, <span class="at">k =</span> <span class="dv">3</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">4</span>) {</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>      detr_shapes[,,index] <span class="ot">&lt;-</span> <span class="fu">lm</span>(subshapes_mat <span class="sc">~</span> subind) <span class="sc">%&gt;%</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">detrend_shapes</span>(<span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="dv">90</span>, <span class="at">k =</span> <span class="dv">3</span>)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>      detr_shapes[,,index] <span class="ot">&lt;-</span> <span class="fu">lm</span>(subshapes_mat <span class="sc">~</span> subind <span class="sc">*</span> subloc) <span class="sc">%&gt;%</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">detrend_shapes</span>(<span class="at">method =</span> <span class="st">"residuals"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrayspecs</span>(<span class="at">p =</span> <span class="dv">90</span>, <span class="at">k =</span> <span class="dv">3</span>)</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As with 2D landmarks we can include a template to improve interpretability, although in this case this template is a 3D surface mesh. This can slow down the process a bit, especially if we ask for too many models, use transparent meshes, or use LOOCV. The template used must be the mesh corresponding to the mean shape of the sample, which needs to be computed beforehand (the shells3D data set includes the mesh corresponding to the specimen closest to the consensus, which can be warped using Morpho::tps3d to obtain the mean mesh, as shown in the next chunk).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate morphospace using raw variation, but with a mesh template that improves visualization:</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co"># First, get shape corresponding to shells3D$mesh_meanspec using geomorph::findMeanSpec,</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>meanspec_id<span class="ot">&lt;-</span> <span class="fu">findMeanSpec</span>(shapes)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>meanspec_shape <span class="ot">&lt;-</span> shapes[,,meanspec_id]</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Then get consensus shape and warp the mean spec mesh to get the mesh corresponding to the consensus using Morpho::tps3d</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>detr_meanshape <span class="ot">&lt;-</span> <span class="fu">expected_shapes</span>(detr_shapes)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>detr_meanmesh <span class="ot">&lt;-</span> <span class="fu">tps3d</span>(<span class="at">x =</span> mesh_meanspec, <span class="at">refmat =</span> meanspec_shape, </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">tarmat =</span> detr_meanshape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we have gotten rid of the noise and have our template prepared, we use the refined shapes to compute the ontogenetic allometric axis of each species using pls_shapes. Then, we use the former to generate a morphospace in which to project the latter, using 3D meshes as background shape models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute allometric axis of each species using pls_shapes</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>pls_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(species), <span class="cf">function</span>(i) {</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> species <span class="sc">==</span> <span class="fu">levels</span>(species)[i]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  subshapes <span class="ot">&lt;-</span> detr_shapes[,,index]</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  subsizes <span class="ot">&lt;-</span> sizes[index]</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pls_shapes</span>(<span class="at">shapes =</span> <span class="fu">two.d.array</span>(subshapes), <span class="at">X =</span> subsizes, <span class="at">LOOCV =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate morphospace from refined variation and project allometric axis, add legend</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>allomsp <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">template =</span> detr_meanmesh, <span class="at">bg.model =</span> <span class="st">"gray"</span>,</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cex.ldm =</span> <span class="dv">0</span>, <span class="at">invax =</span> <span class="dv">1</span>, <span class="at">adj_frame =</span> <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">0.85</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(<span class="at">shapes =</span> detr_shapes, <span class="at">cex =</span> <span class="dv">0</span>, <span class="at">col =</span> species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing for snapshot: rotate mean shape to the desired orientation
 (don't close or minimize the rgl device).Press &lt;Enter&gt; in the console to continue:
This can take a few seconds...
DONE.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"Refined morphospace"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># use proj_axis outside the pipeline with pipe = FALSE</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(species)) {</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_axis</span>(<span class="at">mspace =</span> allomsp, <span class="at">obj =</span> pls_list[[i]], <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">col =</span> i, </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">type =</span> <span class="dv">2</span>, <span class="at">axis =</span> <span class="dv">1</span>, <span class="at">pipe =</span> <span class="cn">FALSE</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can use plot_mspace to plot an allometric axis (represented by the axis resulting from the PLS of shape and size of the entire sample). In order to improve interpretation of results, we will first use expected_shapes to compute the shape expected for each size by the linear regression of the latter on the former (we do this species-wise), to be projected into the allometric axis. Then, we call plot_mspace, including 1) the “mspace” object built with PLS (indicating the first and only axis with axes = 1), 2) the size variable using x, and 3) a legend with legend = TRUE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute shapes expected under the linear relationship of size and shape. The code below will apply expected_shapes to the shapes and sizes of each species, rearrange them as an array, and reorder them according to their original order</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>pred_shapes <span class="ot">&lt;-</span> abind<span class="sc">::</span><span class="fu">abind</span>(</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nlevels</span>(species), <span class="cf">function</span>(i) {</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    index <span class="ot">&lt;-</span> species <span class="sc">==</span> <span class="fu">levels</span>(species)[i]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    subshapes <span class="ot">&lt;-</span> detr_shapes[,,index]</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    subsizes <span class="ot">&lt;-</span> sizes[index]</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expected_shapes</span>(<span class="at">shapes =</span> subshapes, <span class="at">x =</span> subsizes)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  }), </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">along =</span> <span class="dv">3</span>)[,,<span class="fu">dimnames</span>(shapes)[[<span class="dv">3</span>]]]</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Then create allomorphospace using PLS to emphasize allometric variation (this could take a moment due to the leave-one-out cross-validation) and project the expected shapes (with point sizes proportional to each specimen's original size) as well as the species classification (this last thing is necessary for adding a legend):</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>allomsp2 <span class="ot">&lt;-</span> <span class="fu">mspace</span>(detr_shapes, <span class="at">FUN =</span> pls_shapes, <span class="at">X =</span> sizes, <span class="at">LOOCV =</span> <span class="cn">TRUE</span>,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">bg.model =</span> <span class="st">"gray"</span>, <span class="at">cex.ldm =</span> <span class="dv">0</span>, <span class="at">template =</span> detr_meanmesh, </span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">invax =</span> <span class="dv">1</span>, <span class="at">plot =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_shapes</span>(pred_shapes, <span class="at">pch =</span> <span class="dv">21</span>, <span class="at">bg =</span> species, <span class="at">cex =</span> (sizes<span class="sc">/</span><span class="fu">max</span>(sizes))<span class="sc">^</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">proj_groups</span>(<span class="at">groups =</span> species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Preparing for snapshot: rotate mean shape to the desired orientation
 (don't close or minimize the rgl device).Press &lt;Enter&gt; in the console to continue:
This can take a few seconds...
DONE.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, use plot_mspace to create hybrid morphospace with shape against size, and add legend</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspace</span>(allomsp2, <span class="at">x =</span> sizes, <span class="at">axes =</span> <span class="dv">1</span>, <span class="at">xlab =</span> <span class="st">"log-size"</span>, </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">adj_frame =</span> <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">0.85</span>), <span class="at">groups =</span> <span class="cn">FALSE</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This can take a few seconds...
DONE.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="morphospace_tutorial_files/figure-html/unnamed-chunk-36-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A quick assessment of these plots tells us that there are two main groups of ontogenies: those from S. quintucoensis and S. subquadrata (which go from roughly quadrate shells with expanded posteriors to more rectangular shells) and the rest of the species, whose ontogenetic trajectories seem to be very similar in terms of orientation and magnitude (all of them go from more oval-like shells to more triangular ones, although the position of the trajectory differs). The exception is S. vacaensis, which show a protracted trajectory which reach some very elongated shell shapes. It is also apparent that the common trend is one of anteroposterior elongation, which seems to be more marked for the two species reaching larger sizes (S. pehuenmapuensis and S. vacaensis).</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>