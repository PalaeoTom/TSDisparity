<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jari Oksanen, adapted by Thomas Smith">

<title>Ordinating data using Vegan</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Ordinating_data_using_vegan_files/libs/clipboard/clipboard.min.js"></script>
<script src="Ordinating_data_using_vegan_files/libs/quarto-html/quarto.js"></script>
<script src="Ordinating_data_using_vegan_files/libs/quarto-html/popper.min.js"></script>
<script src="Ordinating_data_using_vegan_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Ordinating_data_using_vegan_files/libs/quarto-html/anchor.min.js"></script>
<link href="Ordinating_data_using_vegan_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Ordinating_data_using_vegan_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Ordinating_data_using_vegan_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Ordinating_data_using_vegan_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Ordinating_data_using_vegan_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Ordinating data using Vegan</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jari Oksanen, adapted by Thomas Smith </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This vignette describes some of the most commonly used ordination pathways supported by this package. Unconstrained ordination examples cover principal component analysis, principal coordinate analysis, correspondence analysis, and non-metric multidimensional scaling. This vignette shows how to interpret their results by fitting environmental vectors and factors or smooth environmental surfaces to the graph. The basic plotting command, and more advanced plotting commands for congested plots are also discussed, as well as adding items such as ellipses, convex hulls, and other items for classes. The constrained ordination example employs constrained (canonical) correspondence analysis. It shows how a model is defined, and discusses model building and significance tests of the whole ordination, single constraints, and axes.</p>
</section>
<section id="unconstrained-ordinations" class="level2">
<h2 class="anchored" data-anchor-id="unconstrained-ordinations">1.0 Unconstrained ordinations</h2>
<p>The vegan package contains all common ordination methods: Principal component analysis (function rda, or prcomp in the base R), correspondence analysis (cca), and a wrapper for nonmetric multidimensional scaling (metaMDS). Additionally, it contains a function for derived dissimilarity (distance) matrixes from community abundance data in a format compatible with the ape function for principal coordinate analysis (pcoa).</p>
<p>In terms of its applicability to disparity analyses, Vegan is a package that supports basic analyses of categorical and traditional morphometric data. Other packages offer a much greater variety of disparity-analysis-specific support. However, as a package rooted in community ecology, the field that disparity borrows most of its methodological techniques from, it is worthwhile familiarising yourself with the capabilities of vegan.</p>
</section>
<section id="principal-components-analysis-pca" class="level2">
<h2 class="anchored" data-anchor-id="principal-components-analysis-pca">1.1 Principal components analysis (PCA)</h2>
<p>Let’s start simple with principal components analysis. First, check you have vegan and ape installed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">c</span>(<span class="st">"vegan"</span>, <span class="st">"ape"</span>)[<span class="sc">!</span><span class="fu">c</span>(<span class="st">"vegan"</span>, <span class="st">"ape"</span>) <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>]]) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">"vegan"</span>, <span class="st">"ape"</span>)[<span class="sc">!</span><span class="fu">c</span>(<span class="st">"vegan"</span>, <span class="st">"ape"</span>) <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>]])</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Clear your environment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s load the example dataset. This is composed of estimated cover values of 44 different species of lichen and other flora.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: permute</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is vegan 2.6-4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(varespec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Try viewing dataset, see if you can spot any trends.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(varespec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pretty difficult, right? Let’s try ordinating the data using principal component analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>PCA <span class="ot">&lt;-</span> <span class="fu">rda</span>(varespec, <span class="at">scale =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First things first, let’s see how effectively we’ve summarised the variance in the dataset. Plot a bar chart of the proportion of the total eigenvalues accounted for by each principal component. For meaningful visualisation, you want to see the vast majority in the first 2-3 axes (so our visualisations of the data will be meaningful).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">as.vector</span>(PCA<span class="sc">$</span>CA<span class="sc">$</span>eig)<span class="sc">/</span><span class="fu">sum</span>(PCA<span class="sc">$</span>CA<span class="sc">$</span>eig))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">as.vector</span>(PCA<span class="sc">$</span>CA<span class="sc">$</span>eig)<span class="sc">/</span><span class="fu">sum</span>(PCA<span class="sc">$</span>CA<span class="sc">$</span>eig), <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.54 0.25 0.07 0.04 0.03 0.02 0.01 0.01 0.01 0.01 0.01 0.00 0.00 0.00 0.00
[16] 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00</code></pre>
</div>
</div>
<p>The first two axes account for 0.79 of the total eigenvalues, or 79% of the total variance. Its subjective, of course, but such a high proportion of the variance across the first two axes means a visualisation may be useful. Let’s plot it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The default labels are the row and column names. We can refine this. By including ‘display = “sites”’, we can just plot the rows (the sites in this dataset). Argument type let’s us specify the format of these data points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">display =</span> <span class="st">"sites"</span>, <span class="at">type =</span> <span class="st">"points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Conversely, changing the ‘display’ argument to “species” will just plot the columns (the species in this dataset).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">display =</span> <span class="st">"species"</span>, <span class="at">type =</span> <span class="st">"points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If you don’t change the ‘display’ arguments, you can change formatting of both the sites and species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can isolate the PCA scores with the following for further analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sitePCA <span class="ot">&lt;-</span> PCA<span class="sc">$</span>CA<span class="sc">$</span>u <span class="co"># Site scores</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>speciesPCA <span class="ot">&lt;-</span> PCA<span class="sc">$</span>CA<span class="sc">$</span>v <span class="co"># Species scores</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also plot the results of PCA as a biplot, where the species are plotted as arrows which signify the direction in which the cover increases for those species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(<span class="fu">biplot</span>(PCA, <span class="at">choices =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"text"</span>, <span class="st">"points"</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">10</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Don’t worry about the suppressed warnings - they’re just stating that not all arrows could be plotted because some of the species cluster at the origin (i.e.&nbsp;the arrows are of length zero).</p>
<p>You can check out your other options for customising a biplot by running the following.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>?biplot.rda</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thinking about ordinating your data using this function (or any of the others that follow for that matter)? Make sure it’s in the right format. You’ll want to match in the following ways:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(varespec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data.frame"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(varespec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(varespec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "18" "15" "24" "27" "23" "19" "22" "16" "28" "13" "14" "20" "25" "7"  "5" 
[16] "6"  "3"  "4"  "2"  "9"  "12" "10" "11" "21"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(varespec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Callvulg" "Empenigr" "Rhodtome" "Vaccmyrt" "Vaccviti" "Pinusylv"
 [7] "Descflex" "Betupube" "Vacculig" "Diphcomp" "Dicrsp"   "Dicrfusc"
[13] "Dicrpoly" "Hylosple" "Pleuschr" "Polypili" "Polyjuni" "Polycomm"
[19] "Pohlnuta" "Ptilcili" "Barbhatc" "Cladarbu" "Cladrang" "Cladstel"
[25] "Cladunci" "Cladcocc" "Cladcorn" "Cladgrac" "Cladfimb" "Cladcris"
[31] "Cladchlo" "Cladbotr" "Cladamau" "Cladsp"   "Cetreric" "Cetrisla"
[37] "Flavniva" "Nepharct" "Stersp"   "Peltapht" "Icmaeric" "Cladcerv"
[43] "Claddefo" "Cladphyl"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>?rda</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Argument ‘x’ needs to be a data frame where the rows are samples and the columns are the variables. Bear in mind that your samples can be sites, if you’re sampling environmental variables or species coverage, or species, if you’re sampling species traits. In the case of disparity analysis, the latter will be the case. As such, make sure each row represents a taxonomic unit, and each column represents a trait.</p>
</section>
<section id="principal-coordinate-analysis-pcoa" class="level2">
<h2 class="anchored" data-anchor-id="principal-coordinate-analysis-pcoa">1.2 principal coordinate analysis (PCOA)</h2>
<p>Vegan doesn’t support principal coordinate analysis, the ordination of dissimilarity/distance matrices, but ape does. Let’s load it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we need to convert our data matrix into a distance matrix. There is a base R which offers a limited selection of distance metrics to choose from. Let’s take a look at our options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>?dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our options are “euclidean”, “maximum”, “manhattan”, “canberra”, “binary” or “minkowski”. If your dataset is 100% complete (i.e) has no missing data, you could use the default Euclidean distance. If your dataset includes any missing data, however, this function will simply drop the rows in which the missing entries occur from the analysis. vegdist offers a much greater variety of distance metrics to choose from. Let’s take a look.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>?vegdist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lots to choose from! It it worth familiarising yourself not just with how these distances are calculated, but also why they were derived in the first place. This will usually tell you whether they are applicable to your study.</p>
<p>Let’s derive a distance matrix from our data, one using the Euclidean distance, one using the Gower coefficient.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dist.E <span class="ot">&lt;-</span> <span class="fu">vegdist</span>(varespec, <span class="at">method =</span> <span class="st">"euclidean"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>dist.G <span class="ot">&lt;-</span> <span class="fu">vegdist</span>(varespec, <span class="at">method =</span> <span class="st">"gower"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s explore the properties of one of these distance matrices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(dist.E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "dist"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(dist.E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "double"</code></pre>
</div>
</div>
<p>Just like the output of the base R dist function. Likewise, these distance matrices can be transformed into matrix objects using as.matrix. You might find these objects more intuitive to view and manipulate (I certainly do).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>distM.E <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dist.E)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>distM.G <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dist.G)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(distM.E)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(distM.G)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These distance matrices can be manipulated using basic R matrix indexing. Try identifying the pairs of sites separated by the greatest and smallest distances.</p>
<p>Simple pre-ordination indices of disparity can be calculated from these distance matrices using base R functions. For example, from the standard ‘dist’ objects (which do not include the all-zero diagonal), the mean pairwise distance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(dist.E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 56.13408</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(dist.G)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1985776</code></pre>
</div>
</div>
<p>However, for most standard indices of disparity we need to ordinate. We can ordinate distance matrices of either format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>PCOA.E <span class="ot">&lt;-</span> <span class="fu">pcoa</span>(dist.E)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>PCOA.G <span class="ot">&lt;-</span> <span class="fu">pcoa</span>(dist.G)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before we do anything, we must check the relative eigenvalues.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(PCOA.E<span class="sc">$</span>values<span class="sc">$</span>Relative_eig, <span class="at">main =</span> <span class="st">"Euclidean distances"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(PCOA.G<span class="sc">$</span>values<span class="sc">$</span>Relative_eig, <span class="at">main =</span> <span class="st">"Gower distances"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-23-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Uh-oh, notice anything about the Gower distances plot? Negative eigenvalues have been introduced. This isn’t good - it means that additional variance has been added into the data to make the space defined by the axes of the ordination with positive eigenvalues.</p>
<p>Luckily, function pcoa has a pair of built-in correction options: the so-called Lingoes and Cailliez corrections. These corrections add constants to each non-diagonal distance in the matrix at different stages in the ordination process. The outcomes should be the same - no negative eigenvalues. Let’s try each and check.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>PCOA.G.cailliez <span class="ot">&lt;-</span> <span class="fu">pcoa</span>(dist.G, <span class="at">correction =</span> <span class="st">"cailliez"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>PCOA.G.lingoes <span class="ot">&lt;-</span> <span class="fu">pcoa</span>(dist.G, <span class="at">correction =</span> <span class="st">"lingoes"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(PCOA.G.cailliez<span class="sc">$</span>values<span class="sc">$</span>Rel_corr_eig, <span class="at">main =</span> <span class="st">"Gower distance relative eigenvalues - Cailliez correction"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(PCOA.G.lingoes<span class="sc">$</span>values<span class="sc">$</span>Rel_corr_eig, <span class="at">main =</span> <span class="st">"Gower distance relative eigenvalues - Lingoes correction"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Hey presto, no more negative eigenvalues. It doesn’t really matter which of these two corrections you use. However, it does matter when you apply them.</p>
<p>If the purpose of your study is to visualize the distribution of variation in your dataset, then corrections like this are not necessary and actually spread the variance in your dataset across more axes (compare the corrected relative eigenvalues with the uncorrected - you’ll see the first couple of axes have higher values in the latter), thereby decreasing the information content of your visualizations.</p>
<p>If you intend to quantify the spread of your samples across all or most axes (i.e.&nbsp;conduct a quantitative analysis of disparity), then it is important to ensure that the space defined by your ordination is Euclidean.</p>
<p>Let’s check out our PCAs. We’ll plot the first two axes of each uncorrected ordination. It is good practice when doing this to report the relative eigenvalues accounted for by each axis. I’ve done this below, rounding to three decimal places.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCOA.G.cailliez<span class="sc">$</span>vectors[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)], <span class="at">main =</span> <span class="st">"Gower distances"</span>, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">paste0</span>(<span class="st">"PCOA axis 1 ("</span>, <span class="fu">round</span>(PCOA.G<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">1</span>], <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">")"</span>), </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">paste0</span>(<span class="st">"PCOA axis 2 ("</span>, <span class="fu">round</span>(PCOA.G<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">2</span>], <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">")"</span>))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCOA.E<span class="sc">$</span>vectors[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)], <span class="at">main =</span> <span class="st">"Euclidean distances"</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="fu">paste0</span>(<span class="st">"PCOA axis 1 ("</span>, <span class="fu">round</span>(PCOA.E<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">1</span>], <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">")"</span>), </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="fu">paste0</span>(<span class="st">"PCOA axis 2 ("</span>, <span class="fu">round</span>(PCOA.E<span class="sc">$</span>values<span class="sc">$</span>Relative_eig[<span class="dv">2</span>], <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">")"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These plots look very different but the relative eigenvalues explain why: The ordination of the raw Euclidean distance matrix summarises over 75% of the variance in the dataset across the first two axes, whereas the ordination of the Gower distance matrix captures less than 50%.</p>
<p>This demonstrates the power of a complete data matrix. If you have one - fantastic. You can draw powerful insights into the structure of your data from simple two-dimensional visualisations. This is highly unlikely in analyses of disparity - unless your dataset is small. In these cases, you’ll need to use another distance metric, such as the Gower coefficient.</p>
</section>
<section id="non-metric-multidimensional-scaling-nmds" class="level2">
<h2 class="anchored" data-anchor-id="non-metric-multidimensional-scaling-nmds">1.3 Non-metric multidimensional scaling (NMDS)</h2>
<p>PCOA provides a Euclidean representation of a set of samples whose relative similarities to one another are quantified by some distance metric. As you have seen, sometimes 2-3 axes won’t cut it in terms of representing the bulk of the variation in the dataset. One solution to this is to plot as many axes as possible. However, this can make the results of your analyses hard to understand.</p>
<p>Another solution is to take a different approach to dimensionality reduction and use non-metric multidimensional scaling.</p>
<p>Let’s take a look at the function that does this in vegan.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>?metaMDS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lots of arguments here. They key ones to look at ‘k’, ‘try’, ‘trymax’, ‘autotransform’, and ‘distance’. ‘K’ specifies the number of dimensions your distance matrix will be reduced to (default = 2). ‘try’ and ‘trymax’ specify the minimum and maximum number of random placements of objects in ordination space that will be attempted during an iteration respectively. An iteration will stop before ‘trymax’ is reached if an optimal solution is reached. ‘distance’ lets you specify a distance metric from vegdist if you submit a community data object, rather than a dist object or symmetric square matrix. Finally, ‘autotransform’ dictates whether the function applies basic transformations regularly employed to community data if said data type is provided (default = TRUE).</p>
<p>Let’s run a series of quick analyses. We’ll use the uncorrected Gower and Euclidean distance matrices we generated earlier. First we need to figure out the best compromise between minimising the dimensionality of the resulting ordination and accurately representing the distances separating the sites.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>NMDS.stress.test <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">title =</span> <span class="st">"NMDS stress plot"</span>) { </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="fu">replicate</span>(<span class="dv">10</span>, <span class="fu">metaMDS</span>(x, <span class="at">k =</span> <span class="dv">1</span>, <span class="at">trace =</span> F)<span class="sc">$</span>stress), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>),<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.30</span>), <span class="at">xlab =</span> <span class="st">"# of Dimensions"</span>, <span class="at">ylab =</span> <span class="st">"Stress"</span>, <span class="at">main =</span> title)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(<span class="fu">rep</span>(i <span class="sc">+</span> <span class="dv">1</span>,<span class="dv">10</span>),<span class="fu">replicate</span>(<span class="dv">10</span>, <span class="fu">metaMDS</span>(x, <span class="at">autotransform =</span> F, <span class="at">k =</span> i <span class="sc">+</span> <span class="dv">1</span>, <span class="at">trace =</span> F)<span class="sc">$</span>stress))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">NMDS.stress.test</span>(dist.E, <span class="at">title =</span> <span class="st">"NMDS stress plot - Euclidean distance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data

Warning in metaMDS(x, autotransform = F, k = i + 1, trace = F): stress is
(nearly) zero: you may have insufficient data</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">NMDS.stress.test</span>(dist.G, <span class="at">title =</span> <span class="st">"NMDS stress plot - Gower distance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Interpretations of these stress values is notoriously subjective. However, a widely-applied rule of thumb is that values &gt;0.2 are a no-go. Some people will go as far as to break down how stress values below 0.2 should be intepreted (e.g.&nbsp;0.1-0.2 are fine but should be treated with caution, 0.05-0.1 are good, &lt;0.05 are excellent). However, this is very subjective and data dependent. For the purpose of this exercise, we just want to get below 0.2.</p>
<p>In both cases, two dimensions are sufficient, so let’s run a final set of analyses with two dimensions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>NMDS.E <span class="ot">&lt;-</span> <span class="fu">metaMDS</span>(dist.E, <span class="at">k =</span> <span class="dv">2</span>, <span class="at">trymax =</span> <span class="dv">200</span>, <span class="at">trace =</span> F)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>NMDS.G <span class="ot">&lt;-</span> <span class="fu">metaMDS</span>(dist.G, <span class="at">k =</span> <span class="dv">2</span>, <span class="at">trymax =</span> <span class="dv">200</span>, <span class="at">trace =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can draw a Shepard diagram to compare how the ordination distances fit against the original dissimilarities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stressplot</span>(NMDS.G, <span class="at">main =</span> <span class="st">"Gower distances"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stressplot</span>(NMDS.E, <span class="at">main =</span> <span class="st">"Euclidean distances"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These plots neatly demonstrate how two ordination axes produce a better fit when summarising the Euclidean distances instead of the Gower distances (we’re looking for a linear relationship). Some noise at the tails of the distribution is to be expected. Hence we can proceed with both. However, before you do, try ordinating both distance matrices with three axes and comparing the stressplots.</p>
<p>Once you’ve done that, plot and compare the two ordinations using the chunk below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(NMDS.G<span class="sc">$</span>points, <span class="at">main =</span> <span class="st">"Gower distances"</span>, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">paste0</span>(<span class="st">"NMDS axis 1"</span>), </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">paste0</span>(<span class="st">"NMDS axis 2"</span>))</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(NMDS.E<span class="sc">$</span>points, <span class="at">main =</span> <span class="st">"Euclidean distances"</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="fu">paste0</span>(<span class="st">"NMDS axis 1"</span>), </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="fu">paste0</span>(<span class="st">"NMDS axis 2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They don’t look too dissimilar to the PCOA plots. However, remember these are non-metric spaces. The distances between the points no longer carry consistent meaning and so the information content of these plots is limited.</p>
</section>
<section id="other-ordination-methods-in-vegan" class="level2">
<h2 class="anchored" data-anchor-id="other-ordination-methods-in-vegan">1.4 Other ordination methods in Vegan</h2>
<p>Vegan includes functions for a couple of other ordination techniques that are popular in community ecology. Most of these don’t see regular use in contemporary disparity analyses but they are worth exploring, just in case a use strikes you!</p>
<section id="correspondence-analysis-ca" class="level3">
<h3 class="anchored" data-anchor-id="correspondence-analysis-ca">Correspondence analysis (CA)</h3>
<p>PCA preserves Euclidean distances among samples (and so if affected by double zeros). Correspondence analysis preserves chi-square distances (and so is unaffected by double zeros). PCA assumes a linear relation between variables and ordination axes, CA a uni-modal relationship. These are the core differences between PCA and CA which will dictate which method you should use. In almost all cases, because the variation you will sample using traditional morphometrics, geometric morphometrics, and outline methods will be relatively constrained, PCA will be the most appropriate. Nevertheless let’s run through a short example using a different dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(dune)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>CA <span class="ot">&lt;-</span> <span class="fu">cca</span>(dune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the first two axes with the proportion of eigenvalues accounted for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CA, <span class="at">main =</span> <span class="st">"Correspondence analysis"</span>, </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">paste0</span>(<span class="st">"CA axis 1 ("</span>, <span class="fu">round</span>(CA<span class="sc">$</span>CA<span class="sc">$</span>eig[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">sum</span>(CA<span class="sc">$</span>CA<span class="sc">$</span>eig), <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">")"</span>), </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">paste0</span>(<span class="st">"CA axis 2 ("</span>, <span class="fu">round</span>(CA<span class="sc">$</span>CA<span class="sc">$</span>eig[<span class="dv">2</span>]<span class="sc">/</span><span class="fu">sum</span>(CA<span class="sc">$</span>CA<span class="sc">$</span>eig), <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">")"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The first two axes account for less than half the variance in the dataset, so more than two would probably be needed for a reasonable representation.</p>
<p>You can extract the site and species scores with the following for further analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>sitesCA <span class="ot">&lt;-</span> CA<span class="sc">$</span>CA<span class="sc">$</span>u</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>speciesCA <span class="ot">&lt;-</span> CA<span class="sc">$</span>CA<span class="sc">$</span>v</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Why not try analysing the varespec data using CA and comparing it to the results of the PCA?</p>
</section>
<section id="detrended-correspondence-analysis" class="level3">
<h3 class="anchored" data-anchor-id="detrended-correspondence-analysis">Detrended correspondence analysis</h3>
<p>A modified version of CA for analysing sparse ecological gradient data (e.g.&nbsp;time-series of species colonisation). It was developed with the intention of rectifying two alleged faults of standard correspondence analysis: the apparent curvature of straight gradients and packing of sites at the ends of the gradient. It doesn’t see much use today and will be of little relevance to most of you.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>DCA <span class="ot">&lt;-</span> <span class="fu">decorana</span>(dune)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DCA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>DCA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
decorana(veg = dune) 

Detrended correspondence analysis with 26 segments.
Rescaling of axes with 4 iterations.
Total inertia (scaled Chi-square): 2.1153 

                       DCA1   DCA2    DCA3    DCA4
Eigenvalues          0.5117 0.3036 0.12125 0.14267
Additive Eigenvalues 0.5117 0.2985 0.12242 0.12984
Decorana values      0.5360 0.2869 0.08136 0.04814
Axis lengths         3.7004 3.1166 1.30055 1.47888</code></pre>
</div>
</div>
<p>See the decorana function information for further details about the method if you’re interested. However, it will likely be of little use in analyses of disparity.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>?decorana</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="canonical-correspondence-analysis-cca" class="level3">
<h3 class="anchored" data-anchor-id="canonical-correspondence-analysis-cca">Canonical correspondence analysis (CCA)</h3>
<p>One of three methods of constrained ordination supported by Vegan. Constrained ordination methods analyse at least two matrices at once and seek to identify how much of the variance in one is explained by the other. While unconstrained ordination methods summarise and present all the variation in a dataset, constrained methods will only display variation in the response data that can be attributed to the predictor data.</p>
<p>There are constrained equivalents of each major unconstrained ordination method. For principal components analysis, there is redundancy analysis (RDA). For principal coordinates analysis and non-metric multidimensional scaling, there is distance-based redundancy analysis (db-RDA). Finally, for correspondence analysis, there is canonical correspondence analysis (CCA).</p>
<p>These methods are surprisingly rare in analyses of disparity. However, there potential utility is obvious. In Vegan, each constrained ordination method has its own function: CCA has cca (it switches from CA to CCA when a constraining matrix is submitted as argument ‘y’), RDA has rda (same as cca, switches from PCA to RDA if ‘y’ is a constraining matrix), non-RDA has capscale. All functions work in broadly the same way, so we’ll just run an RDA using the dune dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>?rda</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is easiest to specify a constrained ordination is through a forumla. Here we are exploring to what degree variables A1 and management (from the dune.env dataset) constrain our base dataset.</p>
<p>When analysing abundance data, it is preferable to apply the Hellinger transformation to minimise the impact of vastly different sample total abundances. However, this is not necessary in analyses of disparity so we won’t bother here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"dune.env"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>RDA <span class="ot">&lt;-</span> <span class="fu">rda</span>(dune <span class="sc">~</span> A1 <span class="sc">+</span> Management, <span class="at">data =</span> dune.env)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RDA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>RDA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: rda(formula = dune ~ A1 + Management, data = dune.env)

              Inertia Proportion Rank
Total         84.1237     1.0000     
Constrained   33.5978     0.3994    4
Unconstrained 50.5259     0.6006   15
Inertia is variance 

Eigenvalues for constrained axes:
  RDA1   RDA2   RDA3   RDA4 
15.144 11.862  4.053  2.538 

Eigenvalues for unconstrained axes:
   PC1    PC2    PC3    PC4    PC5    PC6    PC7    PC8    PC9   PC10   PC11 
13.230  8.426  6.798  4.978  3.709  3.044  2.523  2.159  1.799  1.244  0.855 
  PC12   PC13   PC14   PC15 
 0.665  0.476  0.374  0.245 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">RsquareAdj</span>(RDA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$r.squared
[1] 0.3993855

$adj.r.squared
[1] 0.2392216</code></pre>
</div>
</div>
<p>We can see from the printout that these two variables, A1 + Management, explained 0.3994 of the total variance in the dune dataset. Adjusted R-squared measures the strength of the relationship between Y and X after applying a correction to the regular R-squared value to take into account the number of explanatory variables (we want the simplest model possible). This is the statistic that should be reported when model building in this way.</p>
</section>
<section id="testing-the-significance-of-different-terms" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-significance-of-different-terms">Testing the significance of different terms</h3>
<p>Previously, we picked two variables at random for our RDA. What about if we want to include all variables that are statistically important? We can do this via forward selection.</p>
<p>First, let’s generate RDA objects that try to explain the variance in the dune dataset with all and none of the environmental variables. These will serve as our endmember models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all variables</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>RDA.upper <span class="ot">&lt;-</span> <span class="fu">rda</span>(dune <span class="sc">~</span> ., <span class="at">data =</span> dune.env)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co"># no variables</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>RDA.lower <span class="ot">&lt;-</span> <span class="fu">rda</span>(dune <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dune.env)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will use the ordiR2step function to perform forward selection on our 5 environmental variables. This will produce an optimised model. Key arguments include: ‘object’, which specifies our start point, and argument ‘scope’, which specifies our end (so we move from no variables included to all). Argument ‘direction’ specifies how the algorithm should proceed (should it move ‘forward’, adding variables, or take them away, moving ‘backward’, or try ‘both’). Argument R2scope ensures the function will not exceed the R2 of the complete model (i.e.&nbsp;including all variables, defaults to TRUE).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fwd.sel <span class="ot">&lt;-</span> <span class="fu">ordiR2step</span>(RDA.lower, RDA.upper, <span class="at">direction =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Step: R2.adj= 0 
Call: dune ~ 1 
 
                R2.adjusted
&lt;All variables&gt;  0.32508817
+ Management     0.22512409
+ Moisture       0.20050225
+ Manure         0.16723149
+ A1             0.04626579
+ Use            0.01799755
&lt;none&gt;           0.00000000

             Df    AIC    F Pr(&gt;F)   
+ Management  3 87.082 2.84  0.002 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Step: R2.adj= 0.2251241 
Call: dune ~ Management 
 
                R2.adjusted
+ Moisture        0.3450334
&lt;All variables&gt;   0.3250882
+ Manure          0.2779515
+ A1              0.2392216
+ Use             0.2300349
&lt;none&gt;            0.2251241</code></pre>
</div>
</div>
<p>We can access the new model with the following.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>fwd.sel<span class="sc">$</span>call</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>rda(formula = dune ~ Management, data = dune.env)</code></pre>
</div>
</div>
<p>Let’s conduct another RDA using this optimised model and compare it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>RDA.opt <span class="ot">&lt;-</span> <span class="fu">eval</span>(fwd.sel<span class="sc">$</span>call)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>RDA.opt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: rda(formula = dune ~ Management, data = dune.env)

              Inertia Proportion Rank
Total         84.1237     1.0000     
Constrained   29.2307     0.3475    3
Unconstrained 54.8930     0.6525   16
Inertia is variance 

Eigenvalues for constrained axes:
  RDA1   RDA2   RDA3 
14.865 10.690  3.675 

Eigenvalues for unconstrained axes:
   PC1    PC2    PC3    PC4    PC5    PC6    PC7    PC8    PC9   PC10   PC11 
15.270  8.428  6.899  5.675  3.988  3.121  2.588  2.380  1.818  1.376  0.995 
  PC12   PC13   PC14   PC15   PC16 
 0.785  0.661  0.467  0.283  0.159 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">RsquareAdj</span>(RDA.opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$r.squared
[1] 0.3474729

$adj.r.squared
[1] 0.2251241</code></pre>
</div>
</div>
<p>Almost the same amount of variance explained by the management variable alone, with very similar adjusted R-squared values.</p>
<p>Why not try repeating the analyses above after switching argument R2scope to FALSE in the ordiR2step function. What changes?</p>
<p>There are other ways of testing for the significance of constraints. Vegan supports a series of wrapper anova functions.</p>
<p>The below will test the significance of the overall model we originally specified (i.e.&nbsp;dune ~ A1 + management).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(RDA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for rda under reduced model
Permutation: free
Number of permutations: 999

Model: rda(formula = dune ~ A1 + Management, data = dune.env)
         Df Variance      F Pr(&gt;F)    
Model     4   33.598 2.4936  0.001 ***
Residual 15   50.526                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>You can test the significance of each term:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(RDA, <span class="at">by=</span><span class="st">"term"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for rda under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

Model: rda(formula = dune ~ A1 + Management, data = dune.env)
           Df Variance      F Pr(&gt;F)   
A1          1    8.115 2.4091  0.010 **
Management  3   25.483 2.5218  0.002 **
Residual   15   50.526                 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>You can test significance of the marginal effects of each term:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(RDA, <span class="at">by=</span><span class="st">"mar"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for rda under reduced model
Marginal effects of terms
Permutation: free
Number of permutations: 999

Model: rda(formula = dune ~ A1 + Management, data = dune.env)
           Df Variance      F Pr(&gt;F)    
A1          1    4.367 1.2965  0.238    
Management  3   25.483 2.5218  0.001 ***
Residual   15   50.526                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>You can test the significance of each constrained axis:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(RDA, <span class="at">by=</span><span class="st">"axis"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for rda under reduced model
Forward tests for axes
Permutation: free
Number of permutations: 999

Model: rda(formula = dune ~ A1 + Management, data = dune.env)
         Df Variance      F Pr(&gt;F)  
RDA1      1   15.144 4.4960  0.011 *
RDA2      1   11.862 3.5215  0.015 *
RDA3      1    4.053 1.2033  0.546  
RDA4      1    2.538 0.7535  0.717  
Residual 15   50.526                
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="conditioned-or-partial-ordination" class="level3">
<h3 class="anchored" data-anchor-id="conditioned-or-partial-ordination">Conditioned or partial ordination</h3>
<p>All constrained ordination methods can have terms that are partialled out from the analysis before constraints are applied. This lets us reduce noise in the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>RDA.part <span class="ot">&lt;-</span> <span class="fu">rda</span>(dune <span class="sc">~</span> A1 <span class="sc">+</span> Management <span class="sc">+</span> <span class="fu">Condition</span>(Moisture), <span class="at">data=</span>dune.env)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>RDA.part</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: rda(formula = dune ~ A1 + Management + Condition(Moisture), data
= dune.env)

              Inertia Proportion Rank
Total         84.1237     1.0000     
Conditional   27.4865     0.3267    3
Constrained   21.3933     0.2543    4
Unconstrained 35.2439     0.4190   12
Inertia is variance 

Eigenvalues for constrained axes:
  RDA1   RDA2   RDA3   RDA4 
11.281  4.890  3.152  2.070 

Eigenvalues for unconstrained axes:
  PC1   PC2   PC3   PC4   PC5   PC6   PC7   PC8   PC9  PC10  PC11  PC12 
8.211 7.138 4.613 4.027 3.023 2.659 1.867 1.499 0.910 0.641 0.387 0.268 </code></pre>
</div>
</div>
<p>This partials out the effect of ‘moisture’, which affects the significance of the other terms. Why don’t you use the vegan ANOVA functions to explore by how much this has changed the results of the RDA?</p>
</section>
</section>
<section id="fitting-environmental-variables" class="level2">
<h2 class="anchored" data-anchor-id="fitting-environmental-variables">1.5 Fitting environmental variables</h2>
<p>Vegan provides two functions for fitting environmental variables onto ordination: envfit fits vectors of continuous variables and centroids of levels of class variables (defined as factor in R). The arrow shows the direction of the (increasing) gradient, and the length of the arrow is proportional to the correlation between the variable and the ordination; and ordisurf (which requires package mgcv) fits smooth surfaces for continuous variables onto ordination using thin plate splines with cross-validatory selection of smoothness.</p>
<p>Let’s try both using the base RDA of the dune dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>RDA.fit <span class="ot">&lt;-</span>  <span class="fu">envfit</span>(RDA <span class="sc">~</span> A1 <span class="sc">+</span> Management, <span class="at">data=</span>dune.env)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>RDA.fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
***VECTORS

       RDA1     RDA2    r2 Pr(&gt;r)  
A1 -0.91473 -0.40407 0.276  0.053 .
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
Permutation: free
Number of permutations: 999

***FACTORS:

Centroids:
                RDA1    RDA2
ManagementBF  1.4749  1.6884
ManagementHF  1.2223  0.3827
ManagementNM -2.0142  0.7668
ManagementSF  0.2581 -1.9299

Goodness of fit:
               r2 Pr(&gt;r)    
Management 0.6147  0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
Permutation: free
Number of permutations: 999</code></pre>
</div>
</div>
<p>We can plot the results directly or add them to an existing ordination. The arrow shows the direction of the increasing gradient, its length proportional to the correlation between the variable and the ordination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RDA, <span class="at">dis =</span> <span class="st">"site"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RDA.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ordisurf directly adds a fitted surface to an ordination. It returns the result of the fitted thinplate spline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ordisurf</span>(RDA <span class="sc">~</span> A1, <span class="at">data =</span> dune.env)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
y ~ s(x1, x2, k = 10, bs = "tp", fx = FALSE)

Estimated degrees of freedom:
2.91  total = 3.91 

REML score: 42.24929     </code></pre>
</div>
</div>
<p>This is a little more informative!</p>
</section>
<section id="plotting-using-vegan" class="level2">
<h2 class="anchored" data-anchor-id="plotting-using-vegan">1.6 Plotting using Vegan</h2>
<section id="basic-plotting" class="level3">
<h3 class="anchored" data-anchor-id="basic-plotting">Basic plotting</h3>
<p>Finally, vegan has a variety of functions that let you customise your ordinations.</p>
<p>Let’s start with a basic plot of our varespec PCA data from way, way back in this tutorial. Let’s plot the sites as points and species (variables) as crosses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"p"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If you want finer control over your plot, it’s best to start with a blank plot first. This can be achieved by changing argument ‘type’ to “n” (i.e.&nbsp;you’ll just plot the axes). Let’s make the sites and species more distinct this way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"n"</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(PCA, <span class="at">display =</span> <span class="st">"sites"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">bg=</span><span class="st">"yellow"</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(PCA, <span class="at">display =</span> <span class="st">"species"</span>, <span class="at">cex=</span><span class="fl">0.7</span>, <span class="at">col=</span><span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>All vegan ordination methods have a specific plot function. In addition, vegan has an alternative plotting function ordiplot that also knows many non-vegan ordination methods, such as prcomp, cmdscale and isoMDS. All vegan plot functions return invisibly an ordiplot object, so that you can use ordiplot support functions with the results (points, text, identify). Function ordirgl (requires rgl package) provides dynamic three-dimensional graphics that can be spun around or zoomed into with your mouse. Function ordiplot3d (requires package scatterplot3d) displays simple three-dimensional scatterplots.</p>
<p>Ordiplot uses the same arguments as plot.cca (the vegan extension of plot). Why not try experimenting before moving on?</p>
<p>It is worth familiarising yourself with the arguments you can use to customise your plot. Use xlim and ylim to set the limits of your axes and the select argument (which accepts a logical vector which is TRUE for displayed items or a vector of indices of displayed items) to specify which points are plotting. You can also use the following functions to customise your plots.</p>
<p>You can use the ordilabel function to add partially opaque text labels to a plot: some text labels will be covered, but the uppermost will be readable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"points"</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ordilabel</span>(PCA, <span class="at">display =</span> <span class="st">"species"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can use the automatic orditorp function that uses text only if this can be done without overwriting previous labels, but points in other cases. This produces a much tidier version of the labelled plot produced by ordilabel. You have to specify whether you want to label the species (columns) or sites (rows).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"points"</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">orditorp</span>(PCA, <span class="at">display =</span> <span class="st">"species"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can use the automatic ordipointlabel function to plot both point and text labels. It tries to optimize the location of the text to avoid overwriting. However, in cluttered plots it often fails.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"points"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ordipointlabel</span>(PCA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-54-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="adding-items-to-plots" class="level3">
<h3 class="anchored" data-anchor-id="adding-items-to-plots">Adding items to plots</h3>
<p>Probably the most useful thing you can do to your ordination is to add some sort of convex hull to separate groups of points that are distinct from one another in some way. Vegan supports three functions for doing just that.</p>
<p>When adding a convex hull to a constrained ordination, you can simple specify the environmental variable you wish to group by and ordihull will add convex hulls:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RDA, <span class="at">type =</span> <span class="st">"points"</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ordihull</span>(RDA, <span class="at">groups =</span> dune.env<span class="sc">$</span>Management, <span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">draw =</span> <span class="st">"polygon"</span>, <span class="at">alpha =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ordiellipse will add ellipses enclosing all points in the group (these can be altered to encompass the standard deviation or standard error of the groups using the “kind” argument):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RDA, <span class="at">type =</span> <span class="st">"points"</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiellipse</span>(RDA, <span class="at">groups =</span> dune.env<span class="sc">$</span>Management, <span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">draw =</span> <span class="st">"polygon"</span>, <span class="at">alpha =</span> <span class="dv">100</span>, <span class="at">kind =</span> <span class="st">"ehull"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And ordispider links items to their centroids:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RDA, <span class="at">type =</span> <span class="st">"points"</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ordispider</span>(RDA, <span class="at">groups =</span> dune.env<span class="sc">$</span>Management, <span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Unfortunately, these functions only work seamlessly with constrained ordinations. For unconstrained ordinations, we have to specify the groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>groups <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">8</span>),<span class="fu">rep</span>(<span class="dv">2</span>,<span class="dv">6</span>),<span class="fu">rep</span>(<span class="dv">3</span>,<span class="dv">10</span>)))</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(groups) <span class="ot">&lt;-</span> <span class="st">"grouping"</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PCA, <span class="at">type =</span> <span class="st">"points"</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ordihull</span>(PCA, <span class="at">groups =</span> groups<span class="sc">$</span>grouping, <span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">draw =</span> <span class="st">"polygon"</span>, <span class="at">alpha =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Ordinating_data_using_vegan_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Have a play around with the other functions and see what you can generate!</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>